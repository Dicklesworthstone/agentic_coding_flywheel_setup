name: Auto-Update Internal Checksums

# Runs whenever a file whose SHA-256 is tracked in
# scripts/generated/internal_checksums.sh is changed on main.
# If the checksums are stale, this workflow regenerates
# internal_checksums.sh and commits the update automatically.

on:
  push:
    branches: [main]
    paths:
      - 'scripts/lib/security.sh'
      - 'scripts/lib/agents.sh'
      - 'scripts/lib/update.sh'
      - 'scripts/lib/doctor.sh'
      - 'scripts/lib/install_helpers.sh'
      - 'scripts/lib/logging.sh'
      - 'scripts/lib/state.sh'
      - 'scripts/lib/session.sh'
      - 'scripts/lib/os_detect.sh'
      - 'scripts/lib/errors.sh'
      - 'scripts/lib/user.sh'
      - 'scripts/lib/tools.sh'
      - 'scripts/lib/export-config.sh'
      - 'scripts/acfs-global'
      - 'scripts/acfs-update'
      # Also re-run if the updater script or generator source changes
      - 'scripts/update-internal-checksums.sh'
      - 'packages/manifest/src/generate.ts'
  workflow_dispatch: {}

concurrency:
  group: update-internal-checksums
  cancel-in-progress: false

jobs:
  update-internal-checksums:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Regenerate internal_checksums.sh
        run: |
          chmod +x ./scripts/update-internal-checksums.sh
          ./scripts/update-internal-checksums.sh

      - name: Commit updated checksums (if changed)
        run: |
          if git diff --quiet scripts/generated/internal_checksums.sh; then
            echo "✓ internal_checksums.sh already up to date — nothing to commit"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add scripts/generated/internal_checksums.sh
          git commit -m "chore(generated): auto-update internal script checksums" \
            -m "Regenerated by update-internal-checksums workflow after a tracked" \
            -m "script was modified.  Run ./scripts/update-internal-checksums.sh" \
            -m "locally to perform the same update without bun."

          # Rebase on top of any concurrent commits to avoid conflicts
          git pull --rebase origin main || {
            echo "⚠️ Rebase failed — will retry on next push"
            exit 1
          }

          git push
          echo "✓ Pushed updated internal_checksums.sh"
