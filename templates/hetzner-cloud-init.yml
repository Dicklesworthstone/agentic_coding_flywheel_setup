#cloud-config
# ============================================================
# ACFS Hetzner Cloud-Init Template
# ============================================================
#
# Usage (Hetzner Cloud Console or hcloud CLI):
#   1. Create a new server (Ubuntu 24.04 or later recommended)
#   2. Under "Cloud config", paste this file
#   3. Add your SSH key in the Hetzner UI
#   4. Launch the server
#
# hcloud CLI example:
#   hcloud server create \
#     --name acfs-dev \
#     --type cpx31 \
#     --image ubuntu-24.04 \
#     --ssh-key your-key-name \
#     --user-data-from-file templates/hetzner-cloud-init.yml
#
# After boot (~5-10 min), SSH in and ACFS will be fully installed.
# To monitor install progress: tail -f /var/log/acfs/install.log
# ============================================================

# Set locale and timezone
locale: en_US.UTF-8
timezone: UTC

# Ensure system is updated before ACFS install
package_update: true
package_upgrade: true

# Install minimal bootstrap dependencies
packages:
  - curl
  - git
  - jq
  - ca-certificates
  - unzip
  - tmux

# Create the target user (ACFS will configure the rest)
users:
  - name: ubuntu
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh_authorized_keys:
      # Replace with your SSH public key(s):
      - ssh-ed25519 AAAA... your-email@example.com

# Run ACFS installer after first boot
runcmd:
  # Log everything for debugging
  - mkdir -p /var/log/acfs
  - |
    exec > >(tee -a /var/log/acfs/cloud-init.log) 2>&1
    echo "=== ACFS cloud-init started at $(date -Iseconds) ==="

    # Run the ACFS installer in non-interactive mode
    # --yes: skip all prompts
    # --mode vibe: enable passwordless sudo and full agent permissions
    curl -fsSL "https://raw.githubusercontent.com/Dicklesworthstone/agentic_coding_flywheel_setup/main/install.sh" \
      | bash -s -- --yes --mode vibe 2>&1 | tee -a /var/log/acfs/install.log

    echo "=== ACFS cloud-init finished at $(date -Iseconds) ==="

# Write a post-install message
final_message: |
  ACFS cloud-init complete.
  System uptime: $UPTIME
  SSH as 'ubuntu' and run 'onboard' to get started.
